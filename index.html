<!DOCTYPE html>
<html>
    <head>
        <style>
            #gameplayWrapper {
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div id="gameplayWrapper">
            <canvas id="gameplay"></canvas>
            <br>
            <span id="test">Nothing</span>
            <br><br>
            <span>Use the keys ZSXDCFV to hit the notes<br>Hit within 100 ms of notes overlapping the red bar to get a Good</span>
        </div>
    </body>
    <script>
        var canvas = document.getElementById("gameplay");
        canvas.width = window.innerWidth * .9;
        canvas.height = window.innerHeight * .6;
        canvas.style.border = "1px solid black";
        var context = canvas.getContext;
        context = canvas.getContext('2d');
        var test = document.getElementById("test");
        
        //User options
        var speed = 1;
        var barHeight = 0.9
        var columnWidth = 30;
        var numOfColumns = 7;
        var msAllowedAfterBar = 500;
        var timeUntilNextNote = 1000;
        
        // (((Number of pixels the notes has to move) / one frame per second) * number of milliseconds in one frame) / speed
        var timeLeftValue = Math.round((((canvas.height * barHeight) / 60) * 1000) / speed) ;
        
        var datePressed;
        var timePressed;
        var hitMs;
        var prevUpdate = Date.now();
        var noteSrc = 0;
        var centerX = canvas.width/2;

        //First dimension is the column number
        //Second dimension is the order of creation
        var noteArray = [[]];
        for (var i = 0; i < numOfColumns; i++) {
            noteArray[i] = [];
        }
        var timeSinceLastNote = 0;
        var totalColumnWidth = columnWidth * numOfColumns;
        var leftoverWidth = canvas.width - totalColumnWidth;
        
        function updateScreen() {
            requestAnimationFrame(updateScreen);
            context.clearRect(0, 0, canvas.width, canvas.height);
            if (timeSinceLastNote > timeUntilNextNote) {
                addNote();
                timeSinceLastNote = 0;
            }
            
            context.fillStyle = "#FF0000";
            context.fillRect(leftoverWidth / 2, canvas.height * barHeight, totalColumnWidth, 10);
            
            //console.log(timeSinceLastNote);
            //console.log(noteArray);
            for (var i = 0; i < numOfColumns; i++) {
                //console.log(noteArray[i]);
                for (var j = noteArray[i].length - 1 ; j >= 0; j--){
                    //console.log(noteArray[i][j]);
                    
                    noteArray[i][j].update();
                }
            }
            
            //console.log(noteArray.length);
            //console.log(canvas.width + " " + canvas.height);
            
            timeSinceLastNote += Date.now() - prevUpdate;
            
            prevUpdate = Date.now();
        }
        
        function addNote() {
            var col = Math.floor(Math.random() * 7);
            noteArray[col].push(new Note(0, speed, columnWidth, col, (col * columnWidth) + (leftoverWidth / 2)));
        }
        
        function removeNote(col) {
            noteArray[col].shift(0);
        }
        
        updateScreen();
        
        function Note(y, dy, width, column, colX) { // Red Note
            this.y = y;
            this.dy = dy;
            this.width = width;
            this.timeCreated = (new Date()).getTime();
            this.timeLeft = timeLeftValue;
            this.column = column;
            this.colX = colX;
            
            if (this.column % 2 == 1) {
                this.fillColor = "blue";
            } else {
                this.fillColor = "gray";
            }

            this.draw = function() {
                context.fillStyle = this.fillColor;
                context.fillRect(/*centerX - (width / 2)*/this.colX, this.y, width,  10); // Note
            }
            
            this.update = function() {

                if (((noteArray[this.column][0].timeCreated - (new Date()).getTime()) + timeLeftValue) <= -msAllowedAfterBar) {
                    removeNote(this.column);
                }
                
                this.y += this.dy;
                    
                this.currentDuration -= 1;
                this.draw();
            }
        }
        
        /*canvas.addEventListener('touchstart', pressHandle, false);*/
        
        document.addEventListener('keydown', pressHandle, false);
        
        function pressHandle(e) {
            // Keydown
            datePressed = new Date();
            timePressed = datePressed.getTime();
            //console.log((noteArray[0].timeCreated - timePressed) + timeLeftValue);
            if (e.keyCode == 90) { // Z keydown
                judgeNote("0");
            } else if (e.keyCode == 83) { // S keydown
                judgeNote("1");
            } else if (e.keyCode == 88) { // X keydown
                judgeNote("2");
            } else if (e.keyCode == 68) { // D keydown
                judgeNote("3");
            } else if (e.keyCode == 67) { // C keydown
                judgeNote("4");
            } else if (e.keyCode == 70) { // F keydown
                judgeNote("5");
            } else if (e.keyCode == 86) { // V keydown
                judgeNote("6");
            }
            
            //judgeNote("1");
        }
        
        function judgeNote(col) {
            if (noteArray[col].length > 0) {
                hitMs = (noteArray[col][0].timeCreated - timePressed) + timeLeftValue;
            
                if (hitMs > 100 || hitMs < -100) {
                    test.innerHTML = "Bad<br>"
                    test.style.color = "red";
                    removeNote(col);
                } else {
                    test.innerHTML = "Good<br>";
                    test.style.color = "green";
                    removeNote(col);
                }
                if (hitMs > 0) {
                    test.innerHTML += hitMs + "ms Early";
                } else if (hitMs < 0) {
                    test.innerHTML += -hitMs + "ms Late";
                } else {
                    test.innerHTML += hitMs + "ms Exact!";
                }
            }
        }
            
    </script>
</html>