<!DOCTYPE html>
<html>
    <head>
        <style>
            #gameplayWrapper {
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div id="gameplayWrapper">
            <canvas id="gameplay"></canvas>
            <br>
            <span id="test">Nothing</span>
            <br><br>
            <span>Hit any key or touch the gameplay screen within 100 ms of notes overlapping the red bar to get a Good</span>
        </div>
    </body>
    <script>
        var canvas = document.getElementById("gameplay");
        canvas.width = window.innerWidth * .9;
        canvas.height = window.innerHeight * .6;
        canvas.style.border = "1px solid black";
        var context = canvas.getContext;
        context = canvas.getContext('2d');
        var test = document.getElementById("test");
        
        var beatCount = 0;
        var speed = 1;
        var barHeight = 0.9
        var columnWidth = 30;
        var numOfColumns = 7;
        var msAllowedAfterBar = 500;
        var timeUntilNextNote = 1000;
        
        // (((Number of pixels the notes has to move) / one frame per second) * number of milliseconds in one frame) / speed
        var timeLeftValue = Math.round((((canvas.height * barHeight) / 60) * 1000) / speed) ;
        
        var dPress;
        var nPress;
        var hitMs;
        var prevUpdate = Date.now();
        var noteSrc = 0;
        var centerX = canvas.width/2;
        var noteArray = [];
        var timeSinceLastNote = 0;
        var totalColumnWidth = columnWidth * numOfColumns;
        var leftoverWidth = canvas.width - totalColumnWidth;
        
        function updateScreen() {
            requestAnimationFrame(updateScreen);
            context.clearRect(0, 0, canvas.width, canvas.height);
            if (timeSinceLastNote > timeUntilNextNote) {
                addNote();
                timeSinceLastNote = 0;
            }
            
            context.fillStyle = "#FF0000";
            context.fillRect(leftoverWidth / 2, canvas.height * barHeight, totalColumnWidth, 10);
            
            //console.log(timeSinceLastNote);
            
            for (var i = noteArray.length - 1; i >= 0; i--) {
                noteArray[i].update();
            }
            
            //console.log(noteArray.length);
            //console.log(canvas.width + " " + canvas.height);
            
            timeSinceLastNote += Date.now() - prevUpdate;
            
            prevUpdate = Date.now();
        }
        
        function addNote() {
            var col = Math.floor(Math.random() * 7);
            noteArray.push(new Note(0, speed, columnWidth, col, (col * columnWidth) + (leftoverWidth / 2)));
        }
        
        function removeNote() {
            noteArray.shift(0);
        }
        
        updateScreen();
        
        function Note(y, dy, width, column, colX) { // Red Note
            this.y = y;
            this.dy = dy;
            this.width = width;
            this.timeCreated = (new Date()).getTime();
            this.timeLeft = timeLeftValue;
            this.column = column;
            this.colX = colX;
            //this.exact = exact;

            this.draw = function() {
                context.fillStyle = "black";
                context.fillRect(/*centerX - (width / 2)*/this.colX, this.y, width,  10); // Note
            }
            
            this.update = function() {

                if (((noteArray[0].timeCreated - (new Date()).getTime()) + timeLeftValue) <= -msAllowedAfterBar) {
                    removeNote();
                }
                
                this.y += this.dy;
                    
                this.currentDuration -= 1;
                this.draw();
            }
        }
        
        /*document.body.onkeydown = function(e) {
            context.fillStyle = "blue";     context.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        document.body.onkeyup = function(e) {
            context.fillStyle = "red";     context.fillRect(0, 0, canvas.width, canvas.height);
        }*/
        
        /*canvas.addEventListener('touchstart', pressHandle, false);*/
        
        document.addEventListener('keydown', pressHandle, false);
        
        function pressHandle() {
            // Keydown
            dPress = new Date();
            nPress = dPress.getTime();
        //    console.log("nPress = " + nPress + ", exact = " + noteArray[0].exact + ". offset = " + (nPress - noteArray[0].exact));
            /*if (noteArray[0]) {
                pressValue = duration - noteArray[0].exact;
            }*/
            //console.log((noteArray[0].timeCreated - nPress) + timeLeftValue);
            /*if (e.keyCode == 68) { // D keydown
                judgeNote("1");
            } else if (e.keyCode == 70) { // F keydown
                judgeNote("1");
            } else if (e.keyCode == 74) { // J keydown
                judgeNote("1");
            } else if (e.keyCode == 75) { // K keydown
                judgeNote("1");
            }*/
            
            judgeNote("1");
        }
        
        function judgeNote(column) {
            if (noteArray.length > 0) {
                hitMs = (noteArray[0].timeCreated - nPress) + timeLeftValue;
            
                if (hitMs > 100 || hitMs < -100) {
                    test.innerHTML = "Bad<br>"
                    test.style.color = "red";
                    removeNote();
                } else {
                    test.innerHTML = "Good<br>";
                    test.style.color = "green";
                    removeNote();
                }
                if (hitMs > 0) {
                    test.innerHTML += hitMs + "ms Early";
                } else if (hitMs < 0) {
                    test.innerHTML += -hitMs + "ms Late";
                } else {
                    test.innerHTML += hitMs + "ms";
                }
            }
        }
            
    </script>
</html>