<!DOCTYPE html>
<html>
    <head>
        
    </head>
    <body>
        <canvas id="gameplay"></canvas><br>
        <span id="test"></span><br>
        <div style="width: 100%; height: 5%">
            <textarea id="taPatterning" style="width: 50vw; height: 20vh;"
>ddk 
kkd 
dkk 
kdd </textarea><br>
            <span style="all:unset">
                <label for="tbxScrollSpeed">Scroll Speed (pixels/sec):</label>
                <input type="text" id="tbxScrollSpeed" value="3"><br>
                <label for="tbxNoteSpeed">Note Spawn Speed (in ms)</label>
                <input type="text" id="tbxNoteSpeed" value=200><br>
            </span>
            <input type="button" id="btnUpdate" value="Update" onclick="updateOptions()"><br>
            <span>Use the keys DF JK</span>
        </div>
        
    </body>
    <script>
        var tbxPatterning = document.getElementById("taPatterning");
        tbxPatterning.style.height = window.innerHeight * .2;
        //var patterningLoop = [[]];
        var canvas = document.getElementById("gameplay");
        canvas.width = window.innerWidth * .9;
        canvas.height = window.innerHeight * .6;
        canvas.style.border = "1px solid black";
        var context = canvas.getContext;
        context = canvas.getContext('2d');
        var test = document.getElementById("test");
        
        //var beatCount = 0; Not used
        var speed = 3;
        var targetX = 0.2
        var radius = canvas.height / 13;
        
        // (((Number of pixels the notes has to move) / one frame per second) * number of milliseconds in one frame) / speed = how many milliseconds left
        var timeLeftValue = Math.round((((canvas.width * (1 - targetX)) / 60) * 1000) / speed);
        var dPress;
        var nPress;
        var hitMs;
        var prevUpdate = Date.now();
        var noteSrc = 0;
        var width = 50;
        var centerY = canvas.height/2;
        var noteArray = [];
        var timeSinceLastNote = 0;
        var timeUntilNextNote = 200;
        var noteColor = "red";
        
        var msAllowedAfterTarget = 150;
        
        var redNote = new Image;
        redNote.src = 'redNote.png';
        var blueNote = new Image;
        blueNote.src = 'blueNote.png';
        
        var patterningGroups = ["ddk ", "kkd ", "dkk ", "kdd "];
        var currentPatternGroup = 0;
        var currentPatternGroupNote = 0;
        
        function updateOptions() {
            patterningGroups = [];
            patterningGroups = tbxPatterning.value.split(/\n/);
            //console.log(patterningGroups);
            currentPatternGroup = 0;
            currentPatternGroupNote = 0;
            
            speed = document.getElementById("tbxScrollSpeed").value;
            console.log(speed);
            timeUntilNextNote = document.getElementById("tbxNoteSpeed").value;
            console.log(timeUntilNextNote);
        }
        
        function updateScreen() {
            requestAnimationFrame(updateScreen);
            context.clearRect(0, 0, canvas.width, canvas.height);
            if (timeSinceLastNote > timeUntilNextNote) {
                var i = patterningGroups;
                var j = currentPatternGroup;
                var k = currentPatternGroupNote;
                
                //console.log(i.length + " " + j + " " + k);

                if (patterningGroups[currentPatternGroup].substring(currentPatternGroupNote, currentPatternGroupNote + 1) == "d") {
                    //console.log(patterningGroups[currentPatternGroup].substring(currentPatternGroupNote, currentPatternGroupNote + 1));
                    addNote("red");
                } if (patterningGroups[currentPatternGroup].substring(currentPatternGroupNote, currentPatternGroupNote + 1) == "k") {
                    //console.log(patterningGroups[currentPatternGroup].substring(currentPatternGroupNote, currentPatternGroupNote + 1));
                    addNote("blue");
                }
                
                //console.log( currentPatternGroupNote + " " + currentPatternGroup.toString.length)
                if (currentPatternGroupNote >= patterningGroups[currentPatternGroup].length - 1) {
                    //console.log(patterningGroups[currentPatternGroup].length);
                    currentPatternGroupNote = 0;
                    currentPatternGroup = Math.floor(Math.random() * patterningGroups.length);
                    //console.log(patterningGroups);
                    /*if (currentPatternGroup >= patterningGroups.length - 1) {
                        currentPatternGroup = 0;
                    } else {
                        console.log(currentPatternGroup + " " + (patterningGroups.length - 1));
                        currentPatternGroup++;
                    }*/ // Looping patterning
                } else {
                    currentPatternGroupNote++; 
                }
                
                timeSinceLastNote = 0;
                
                
            } 
            
            context.fillStyle = "#FF0000";
            context.beginPath();
            context.arc(canvas.width * targetX, canvas.height/2, radius, 10, 0, 2 * Math.PI);
            context.stroke();
            //console.log(canvas.width * targetX);
            //console.log(canvas.height/2);
            
            //console.log(timeSinceLastNote);
            
            for (var i = noteArray.length - 1; i >= 0; i--) {
                noteArray[i].update();
            }
            
            //console.log(noteArray.length);
            //console.log(canvas.width + " " + canvas.height);
            
            timeSinceLastNote += Date.now() - prevUpdate;
            
            prevUpdate = Date.now();
        }
        
        function addNote(color) {
            noteArray.push(new Note(canvas.width, speed, radius, color));
        }
        
        function removeNote() {
            noteArray.shift(0);
        }
        
        updateScreen();
        
        function Note(x, dx, radius, color) { // Red Note
            this.x = x;
            this.dx = dx;
            this.width = width;
            this.timeCreated = (new Date()).getTime();
            this.timeLeft = timeLeftValue;
            this.color = color;
            //this.exact = exact;

            this.draw = function() {
                if (this.color == "blue") {
                    noteSrc = blueNote;
                } else if (this.color == "red") {
                    noteSrc = redNote;
                }
                
                context.fillStyle = this.color;
                context.beginPath();
                context.drawImage(noteSrc, this.x - radius, centerY - radius, radius * 2, radius * 2); // drawing note
                //context.fillRect(centerY - 10, this.y, width,  10); // Old mania style note
            }
            
            this.update = function() {

                if (((noteArray[0].timeCreated - (new Date()).getTime()) + timeLeftValue) <= -msAllowedAfterTarget) {
                    removeNote();
                }
                
                this.x -= this.dx;
                    
                this.currentDuration -= 1;
                this.draw();
            }
        }
        
        /*document.body.onkeydown = function(e) {
            context.fillStyle = "blue";     context.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        document.body.onkeyup = function(e) {
            context.fillStyle = "red";     context.fillRect(0, 0, canvas.width, canvas.height);
        }*/
        
        document.body.onkeydown = function(e) { // Keydown
            dPress = new Date();
            nPress = dPress.getTime();
        //    console.log("nPress = " + nPress + ", exact = " + noteArray[0].exact + ". offset = " + (nPress - noteArray[0].exact));
            /*if (noteArray[0]) {
                pressValue = duration - noteArray[0].exact;
            }*/
            //console.log((noteArray[0].timeCreated - nPress) + timeLeftValue);
            if (e.keyCode == 68) { // D keydown
                judgeNote("blue");
            } else if (e.keyCode == 70) { // F keydown
                judgeNote("red");
            } else if (e.keyCode == 74) { // J keydown
                judgeNote("red");
            } else if (e.keyCode == 75) { // K keydown
                judgeNote("blue");
            }
        }
        
        function judgeNote(color) {
            if (noteArray.length > 0) {
                hitMs = (noteArray[0].timeCreated - nPress) + timeLeftValue;
            
                if ((hitMs > 100 || hitMs < -100) || color != noteArray[0].color) {
                    test.innerHTML = "Bad " + hitMs + "ms";
                    removeNote();
                } else {
                    test.innerHTML = "Good " + hitMs + "ms";
                    removeNote();
                }
            }
        }
            
    </script>
</html>